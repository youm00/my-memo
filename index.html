<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Gist Memo</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;1,300&family=DM+Sans:wght@300;400;500&display=swap');
  :root {
    --bg:#f5f2eb; --paper:#fdfcf8; --ink:#1a1814; --ink-light:#6b6760;
    --accent:#c8441a; --border:#dedad2; --shadow:rgba(26,24,20,0.08);
    --sidebar-w:270px;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--ink);height:100vh;height:100dvh;overflow:hidden;display:flex;flex-direction:column;}

  /* Topbar */
  #topbar{display:flex;align-items:center;gap:0.8rem;padding:0.65rem 1.2rem;background:var(--paper);border-bottom:1px solid var(--border);flex-shrink:0;z-index:10;}
  #topbar h1{font-family:'DM Mono',monospace;font-weight:300;font-size:1rem;letter-spacing:0.08em;}
  #topbar h1 span{color:var(--accent);}
  #status-badge{font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--ink-light);letter-spacing:0.04em;}
  #autosave-indicator{font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--ink-light);opacity:0;transition:opacity 0.4s;}
  #autosave-indicator.show{opacity:1;}
  .topbar-btn{background:transparent;border:1px solid var(--border);color:var(--ink-light);padding:0.32rem 0.75rem;font-family:'DM Mono',monospace;font-size:0.72rem;cursor:pointer;border-radius:3px;transition:all 0.15s;white-space:nowrap;}
  .topbar-btn:hover{border-color:var(--ink-light);color:var(--ink);}
  #btn-settings{margin-left:auto;}

  /* Layout */
  #main{display:flex;flex:1;overflow:hidden;}

  /* Sidebar */
  #sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);background:var(--paper);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
  #sidebar-header{padding:0.8rem;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:0.6rem;}
  #btn-new{background:var(--ink);color:var(--bg);padding:0.5rem;font-family:'DM Mono',monospace;font-size:0.78rem;letter-spacing:0.04em;cursor:pointer;border:none;border-radius:3px;width:100%;transition:background 0.15s;}
  #btn-new:hover{background:var(--accent);}
  #search{width:100%;padding:0.42rem 0.7rem;border:1px solid var(--border);border-radius:3px;background:var(--bg);font-family:'DM Mono',monospace;font-size:0.78rem;color:var(--ink);outline:none;transition:border-color 0.2s;}
  #search:focus{border-color:var(--accent);}

  /* Tag filter bar */
  #tag-filter-bar{display:flex;flex-wrap:wrap;gap:0.3rem;padding:0.5rem 0.8rem;border-bottom:1px solid var(--border);min-height:34px;}
  .tag-filter-chip{font-family:'DM Mono',monospace;font-size:0.65rem;padding:0.2rem 0.55rem;border-radius:20px;border:1px solid var(--border);background:var(--bg);color:var(--ink-light);cursor:pointer;transition:all 0.15s;white-space:nowrap;}
  .tag-filter-chip:hover{border-color:var(--accent);color:var(--accent);}
  .tag-filter-chip.active{background:var(--accent);color:white;border-color:var(--accent);}

  #memo-list{flex:1;overflow-y:auto;padding:0.3rem 0;}

  /* Memo list items */
  .memo-item{padding:0.7rem 1rem;cursor:pointer;border-bottom:1px solid var(--border);transition:background 0.1s;user-select:none;}
  .memo-item:hover{background:var(--bg);}
  .memo-item.active{background:var(--bg);border-left:3px solid var(--accent);padding-left:calc(1rem - 3px);}
  .memo-item.drag-over{border-top:2px solid var(--accent);}
  .memo-item.dragging{opacity:0.4;}
  .memo-item.pinned{border-left:3px solid #e8a020;padding-left:calc(1rem - 3px);}
  .memo-item.pinned.active{border-left:3px solid var(--accent);}
  .memo-item-title{font-size:0.84rem;font-weight:500;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:0.2rem;display:flex;align-items:center;gap:0.4rem;}
  .memo-item-drag{color:var(--border);font-size:0.8rem;cursor:grab;flex-shrink:0;}
  .pin-icon{font-size:0.7rem;flex-shrink:0;}


  /* Backup modal */
  #backup-modal{position:fixed;inset:0;background:rgba(26,24,20,0.5);display:none;align-items:center;justify-content:center;z-index:150;backdrop-filter:blur(2px);}
  #backup-modal.open{display:flex;}
  #backup-box{background:var(--paper);border:1px solid var(--border);border-radius:6px;padding:1.6rem;width:100%;max-width:480px;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 8px 32px var(--shadow);}
  #backup-box h3{font-family:'DM Mono',monospace;font-weight:400;font-size:0.82rem;letter-spacing:0.06em;color:var(--ink-light);text-transform:uppercase;margin-bottom:1rem;}
  #backup-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:0.4rem;margin-bottom:1rem;}
  .backup-item{display:flex;align-items:center;gap:0.8rem;padding:0.65rem 0.9rem;border:1px solid var(--border);border-radius:4px;background:transparent;transition:all 0.15s;}
  .backup-item:hover{border-color:var(--accent);background:var(--bg);}
  .backup-item-info{flex:1;}
  .backup-item-date{font-family:'DM Mono',monospace;font-size:0.75rem;color:var(--ink);}
  .backup-item-meta{font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--ink-light);margin-top:0.15rem;}
  .backup-item-btn{font-family:'DM Mono',monospace;font-size:0.7rem;padding:0.3rem 0.7rem;border:1px solid var(--border);border-radius:3px;background:transparent;color:var(--ink-light);cursor:pointer;transition:all 0.15s;white-space:nowrap;}
  .backup-item-btn:hover{border-color:var(--accent);color:var(--accent);}
  .backup-empty{font-family:'DM Mono',monospace;font-size:0.8rem;color:var(--ink-light);text-align:center;padding:2rem 0;}
  #backup-footer{display:flex;gap:0.6rem;}
  /* Export modal */
  #export-modal{position:fixed;inset:0;background:rgba(26,24,20,0.5);display:none;align-items:center;justify-content:center;z-index:150;backdrop-filter:blur(2px);}
  #export-modal.open{display:flex;}
  #export-box{background:var(--paper);border:1px solid var(--border);border-radius:6px;padding:1.6rem;width:100%;max-width:360px;box-shadow:0 8px 32px var(--shadow);}
  #export-box h3{font-family:'DM Mono',monospace;font-weight:400;font-size:0.82rem;letter-spacing:0.06em;color:var(--ink-light);text-transform:uppercase;margin-bottom:1.2rem;}
  .export-option{display:flex;align-items:center;gap:0.8rem;padding:0.7rem 0.9rem;border:1px solid var(--border);border-radius:4px;margin-bottom:0.5rem;cursor:pointer;transition:all 0.15s;background:transparent;}
  .export-option:hover{border-color:var(--accent);background:var(--bg);}
  .export-option-icon{font-size:1.2rem;width:28px;text-align:center;}
  .export-option-label{font-family:'DM Sans',sans-serif;font-size:0.85rem;color:var(--ink);}
  .export-option-desc{font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--ink-light);}
  #export-cancel{margin-top:0.8rem;width:100%;}
  .memo-item-meta{font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--ink-light);}
  .memo-item-preview{font-size:0.7rem;color:var(--ink-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:0.15rem;}
  .memo-item-tags{display:flex;flex-wrap:wrap;gap:0.25rem;margin-top:0.3rem;}
  .tag-chip{font-family:'DM Mono',monospace;font-size:0.6rem;padding:0.1rem 0.45rem;border-radius:20px;background:#ede9e0;color:var(--ink-light);}

  /* Editor */
  #editor-area{flex:1;display:flex;flex-direction:column;overflow:hidden;}
  #editor-header{padding:0.75rem 1.2rem;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:0.5rem;background:var(--paper);}
  #title-input{font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:500;color:var(--ink);border:none;outline:none;background:transparent;width:100%;}
  #title-input::placeholder{color:var(--border);}
  #meta-info{font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--ink-light);}

  /* Tag editor */
  #tag-editor{display:flex;flex-wrap:wrap;align-items:center;gap:0.3rem;}
  .tag-edit-chip{font-family:'DM Mono',monospace;font-size:0.65rem;padding:0.15rem 0.5rem;border-radius:20px;background:#ede9e0;color:var(--ink-light);display:flex;align-items:center;gap:0.3rem;}
  .tag-edit-chip button{background:none;border:none;cursor:pointer;color:var(--ink-light);font-size:0.75rem;padding:0;line-height:1;}
  .tag-edit-chip button:hover{color:var(--accent);}
  #tag-input{font-family:'DM Mono',monospace;font-size:0.68rem;border:1px dashed var(--border);border-radius:20px;padding:0.15rem 0.6rem;background:transparent;outline:none;color:var(--ink);width:100px;transition:border-color 0.2s;}
  #tag-input:focus{border-color:var(--accent);}
  #tag-input::placeholder{color:var(--border);}

  #memo-body{flex:1;padding:1.4rem 2rem;font-family:'DM Mono',monospace;font-size:0.88rem;line-height:1.8;color:var(--ink);border:none;outline:none;resize:none;background:var(--paper);overflow-y:auto;}
  #memo-body::placeholder{color:var(--border);}
  #editor-footer{padding:0.6rem 1.2rem;padding-bottom:calc(0.6rem + env(safe-area-inset-bottom));border-top:1px solid var(--border);background:var(--bg);display:flex;align-items:center;gap:0.5rem;}
  button.primary{background:var(--accent);color:white;padding:0.42rem 1rem;font-family:'DM Mono',monospace;font-size:0.78rem;cursor:pointer;border:none;border-radius:3px;transition:opacity 0.15s;}
  button.primary:hover{opacity:0.85;}
  button.primary:disabled{background:var(--border);color:var(--ink-light);cursor:not-allowed;}
  button.ghost{background:transparent;color:var(--ink-light);padding:0.42rem 0.75rem;font-family:'DM Mono',monospace;font-size:0.78rem;cursor:pointer;border:1px solid var(--border);border-radius:3px;transition:all 0.15s;}
  button.ghost:hover{border-color:var(--ink-light);color:var(--ink);}
  button.danger{background:transparent;color:#c8441a;padding:0.42rem 0.75rem;font-family:'DM Mono',monospace;font-size:0.78rem;cursor:pointer;border:1px solid #e8b4a4;border-radius:3px;transition:all 0.15s;margin-left:auto;}
  button.danger:hover{background:#fff0ed;}
  #char-count{font-family:'DM Mono',monospace;font-size:0.67rem;color:var(--ink-light);}

  /* Autosave toggle */
  #autosave-wrap{display:flex;align-items:center;gap:0.4rem;margin-left:auto;}
  .toggle{position:relative;display:inline-block;width:32px;height:18px;}
  .toggle input{opacity:0;width:0;height:0;}
  .toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:18px;cursor:pointer;transition:background 0.2s;}
  .toggle-slider:before{content:'';position:absolute;width:12px;height:12px;left:3px;top:3px;background:white;border-radius:50%;transition:transform 0.2s;}
  .toggle input:checked + .toggle-slider{background:var(--accent);}
  .toggle input:checked + .toggle-slider:before{transform:translateX(14px);}
  #autosave-label{font-family:'DM Mono',monospace;font-size:0.67rem;color:var(--ink-light);}

  #empty-state{flex:1;display:flex;align-items:center;justify-content:center;background:var(--paper);}
  #empty-state p{font-family:'DM Mono',monospace;font-size:0.82rem;color:var(--ink-light);}
  #editor{display:none;flex:1;flex-direction:column;overflow:hidden;}

  /* Overlay */
  #overlay{position:fixed;inset:0;background:rgba(245,242,235,0.92);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px);}
  #setup-box{background:var(--paper);border:1px solid var(--border);border-radius:6px;padding:2rem;width:100%;max-width:440px;box-shadow:0 4px 24px var(--shadow);}
  #setup-box h2{font-family:'DM Mono',monospace;font-weight:400;font-size:0.85rem;letter-spacing:0.06em;color:var(--ink-light);margin-bottom:1.5rem;text-transform:uppercase;}
  .field{margin-bottom:1.1rem;}
  .field label{display:block;font-size:0.72rem;font-family:'DM Mono',monospace;color:var(--ink-light);margin-bottom:0.35rem;letter-spacing:0.04em;}
  .field input{width:100%;padding:0.6rem 0.75rem;border:1px solid var(--border);border-radius:3px;background:var(--bg);font-family:'DM Mono',monospace;font-size:0.82rem;color:var(--ink);outline:none;transition:border-color 0.2s;}
  .field input:focus{border-color:var(--accent);}
  .field small{display:block;margin-top:0.3rem;font-size:0.68rem;color:var(--ink-light);}

  /* Toast */
  #toast{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%) translateY(16px);background:var(--ink);color:var(--bg);font-family:'DM Mono',monospace;font-size:0.76rem;letter-spacing:0.04em;padding:0.55rem 1.3rem;border-radius:3px;opacity:0;transition:all 0.22s;pointer-events:none;white-space:nowrap;z-index:200;}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
  #toast.error{background:var(--accent);}

  #btn-menu{display:none;background:transparent;border:1px solid var(--border);color:var(--ink-light);padding:0.32rem 0.65rem;font-size:1rem;cursor:pointer;border-radius:3px;line-height:1;}

  @media(max-width:600px){
    #sidebar{position:fixed;inset:0;top:45px;z-index:50;transform:translateX(-100%);transition:transform 0.25s;width:100%;min-width:unset;}
    #sidebar.open{transform:translateX(0);}
    #btn-menu{display:flex!important;}
    #memo-body{padding:1rem;}
    #memo-list{padding-bottom:env(safe-area-inset-bottom);}
  }
</style>
</head>
<body>

<div id="topbar">
  <button id="btn-menu" onclick="toggleSidebar()">â˜°</button>
  <h1>gist<span>.</span>memo</h1>
  <span id="status-badge">â€”</span>
  <span id="autosave-indicator">è‡ªå‹•ä¿å­˜ä¸­â€¦</span>
  <button class="topbar-btn" id="btn-backup-open">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
  <button class="topbar-btn" id="btn-export-open">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <button class="topbar-btn" id="btn-settings">è¨­å®š</button>
</div>

<div id="main">
  <div id="sidebar">
    <div id="sidebar-header">
      <button id="btn-new">ï¼‹ æ–°ã—ã„ãƒ¡ãƒ¢</button>
      <input id="search" type="search" placeholder="æ¤œç´¢...">
    </div>
    <div id="tag-filter-bar"></div>
    <div id="memo-list"></div>
  </div>

  <div id="editor-area">
    <div id="empty-state"><p>â† ãƒ¡ãƒ¢ã‚’é¸æŠã™ã‚‹ã‹ã€æ–°è¦ä½œæˆã—ã¦ãã ã•ã„</p></div>
    <div id="editor">
      <div id="editor-header">
        <input id="title-input" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
        <div id="tag-editor">
          <input id="tag-input" type="text" placeholder="ã‚¿ã‚°ã‚’è¿½åŠ â€¦">
        </div>
        <div id="meta-info"></div>
      </div>
      <textarea id="memo-body" placeholder="ã“ã“ã«ãƒ¡ãƒ¢ã‚’æ›¸ã..."></textarea>
      <div id="editor-footer">
        <button class="primary" id="btn-save">ä¿å­˜ (âŒ˜S)</button>
        <button class="ghost" id="btn-revert">å…ƒã«æˆ»ã™</button>
        <span id="char-count">0 æ–‡å­—</span>
        <div id="autosave-wrap">
          <span id="autosave-label">è‡ªå‹•ä¿å­˜</span>
          <label class="toggle">
            <input type="checkbox" id="autosave-toggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <button class="ghost" id="btn-pin">ğŸ“Œ ãƒ”ãƒ³ç•™ã‚</button>
        <button class="danger" id="btn-delete">å‰Šé™¤</button>
      </div>
    </div>
  </div>
</div>

<div id="overlay">
  <div id="setup-box">
    <h2>æ¥ç¶šè¨­å®š</h2>
    <div class="field">
      <label>GitHub Personal Access Token</label>
      <input type="password" id="inp-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="off">
      <small>scope: gist ã®ã¿ã§OK</small>
    </div>
    <div class="field">
      <label>Gist ID</label>
      <input type="text" id="inp-gist" placeholder="abc123def456..." autocomplete="off">
      <small>Gistã®URLã®æœ«å°¾ã®è‹±æ•°å­—æ–‡å­—åˆ—</small>
    </div>
    <div style="display:flex;gap:0.6rem;margin-top:0.5rem;">
      <button class="primary" id="btn-connect">æ¥ç¶šã™ã‚‹</button>
      <button class="ghost" id="btn-cancel-setup" style="display:none">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>
<div id="toast"></div>

<!-- Backup modal -->
<div id="backup-modal">
  <div id="backup-box">
    <h3>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´ï¼ˆç›´è¿‘10ä»¶ï¼‰</h3>
    <div id="backup-list"></div>
    <div id="backup-footer">
      <button class="primary" id="btn-backup-now">ä»Šã™ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      <button class="ghost" id="backup-cancel">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- Export modal -->
<div id="export-modal">
  <div id="export-box">
    <h3>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
    <div class="export-option" id="exp-txt">
      <span class="export-option-icon">ğŸ“„</span>
      <div>
        <div class="export-option-label">ãƒ†ã‚­ã‚¹ãƒˆ (.txt)</div>
        <div class="export-option-desc">æœ¬æ–‡ã®ã¿ã‚’ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ä¿å­˜</div>
      </div>
    </div>
    <div class="export-option" id="exp-md">
      <span class="export-option-icon">ğŸ“</span>
      <div>
        <div class="export-option-label">Markdown (.md)</div>
        <div class="export-option-desc">ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚¿ã‚°ãƒ»æœ¬æ–‡ã‚’Markdownå½¢å¼ã§ä¿å­˜</div>
      </div>
    </div>
    <div class="export-option" id="exp-all">
      <span class="export-option-icon">ğŸ“¦</span>
      <div>
        <div class="export-option-label">å…¨ãƒ¡ãƒ¢ä¸€æ‹¬ (.md)</div>
        <div class="export-option-desc">ã™ã¹ã¦ã®ãƒ¡ãƒ¢ã‚’1ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã¦ä¿å­˜</div>
      </div>
    </div>
    <button class="ghost" id="export-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€
let token='', gistId='', memos=[], currentId=null, savedSnapshot=null;
let autosaveTimer=null, autosaveEnabled=false, pendingChanges=false;
let activeTagFilter=null;

// â”€â”€ Init â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  token  = localStorage.getItem('gm_token')   || '';
  gistId = localStorage.getItem('gm_gist_id') || '';
  autosaveEnabled = localStorage.getItem('gm_autosave') === 'true';
  document.getElementById('autosave-toggle').checked = autosaveEnabled;
  if (token && gistId) {
    document.getElementById('inp-token').value = token;
    document.getElementById('inp-gist').value  = gistId;
    connect(false);
  }
});

// â”€â”€ Setup â”€â”€
document.getElementById('btn-connect').addEventListener('click', () => connect(true));
document.getElementById('btn-settings').addEventListener('click', () => {
  document.getElementById('inp-token').value = token;
  document.getElementById('inp-gist').value  = gistId;
  document.getElementById('btn-cancel-setup').style.display = 'inline-block';
  document.getElementById('overlay').style.display = 'flex';
});
document.getElementById('btn-cancel-setup').addEventListener('click', () => {
  document.getElementById('overlay').style.display = 'none';
});

async function connect(showFeedback) {
  token  = document.getElementById('inp-token').value.trim();
  gistId = document.getElementById('inp-gist').value.trim();
  if (!token || !gistId) { if(showFeedback) toast('Tokenã¨Gist IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',true); return; }
  setStatus('æ¥ç¶šä¸­â€¦');
  try {
    const data = await apiGet();
    localStorage.setItem('gm_token', token);
    localStorage.setItem('gm_gist_id', gistId);
    loadFromGist(data);
    document.getElementById('overlay').style.display = 'none';
    setStatus('æ¥ç¶šæ¸ˆã¿');
    if(showFeedback) toast('æ¥ç¶šã—ã¾ã—ãŸ');
  } catch(e) {
    setStatus('ã‚¨ãƒ©ãƒ¼');
    toast('æ¥ç¶šå¤±æ•—ï¼šToken ã¾ãŸã¯ Gist ID ã‚’ç¢ºèªã—ã¦ãã ã•ã„', true);
  }
}

// â”€â”€ Load â”€â”€
function loadFromGist(data) {
  const files = data.files;
  const loaded = [];
  let order = null;
  if (files['index.json']) {
    try { order = JSON.parse(files['index.json'].content); } catch(e) {}
  }
  for (const fname of Object.keys(files)) {
    if (!fname.startsWith('memo_') || !fname.endsWith('.json')) continue;
    try {
      const m = JSON.parse(files[fname].content);
      const id = fname.replace('memo_','').replace('.json','');
      loaded.push({ id, title:m.title||'ç„¡é¡Œ', body:m.body||'', tags:m.tags||[], pinned:m.pinned||false, createdAt:m.createdAt||null, updatedAt:m.updatedAt||null });
    } catch(e) {}
  }
  if (loaded.length === 0) {
    const oldFile = files['memo.txt'] || files[Object.keys(files)[0]];
    const body = oldFile ? oldFile.content : '';
    const now = new Date().toISOString();
    loaded.push({ id:genId(), title:'æœ€åˆã®ãƒ¡ãƒ¢', body, tags:[], pinned:false, createdAt:now, updatedAt:now });
  }
  if (order) {
    loaded.sort((a,b) => { const ia=order.indexOf(a.id),ib=order.indexOf(b.id); if(ia===-1&&ib===-1)return 0; if(ia===-1)return 1; if(ib===-1)return -1; return ia-ib; });
  } else {
    loaded.sort((a,b)=>(b.updatedAt||'').localeCompare(a.updatedAt||''));
  }
  memos = loaded;
  savedSnapshot = deepClone(memos);
  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚­ãƒ¼ä¸€è¦§ã‚’ãƒ¡ãƒ¢ãƒªã«èª­ã¿è¾¼ã‚€
  backupKeys = Object.keys(data.files)
    .filter(f => f.startsWith('bk_') && f.endsWith('.json'))
    .map(f => f.replace('.json',''))
    .sort();
  // Gistä¸Šã«å®Ÿåœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨˜éŒ²
  knownFiles = new Set(Object.keys(data.files));
  renderTagFilterBar();
  renderList();
  if (memos.length > 0) selectMemo(memos[0].id);
}

// â”€â”€ All Tags â”€â”€
function getAllTags() {
  const set = new Set();
  memos.forEach(m => (m.tags||[]).forEach(t => set.add(t)));
  return [...set].sort();
}

// â”€â”€ Tag filter bar â”€â”€
function renderTagFilterBar() {
  const bar = document.getElementById('tag-filter-bar');
  bar.innerHTML = '';
  const tags = getAllTags();
  if (tags.length === 0) { bar.style.display='none'; return; }
  bar.style.display='flex';
  // All chip
  const all = document.createElement('span');
  all.className = 'tag-filter-chip' + (activeTagFilter===null?' active':'');
  all.textContent = 'ã™ã¹ã¦';
  all.addEventListener('click', () => { activeTagFilter=null; renderTagFilterBar(); renderList(); });
  bar.appendChild(all);
  tags.forEach(t => {
    const chip = document.createElement('span');
    chip.className = 'tag-filter-chip' + (activeTagFilter===t?' active':'');
    chip.textContent = '#'+t;
    chip.addEventListener('click', () => {
      activeTagFilter = (activeTagFilter===t) ? null : t;
      renderTagFilterBar(); renderList();
    });
    bar.appendChild(chip);
  });
}

// â”€â”€ Memo list â”€â”€
function renderList(filter) {
  const list = document.getElementById('memo-list');
  list.innerHTML = '';
  const q = (filter !== undefined ? filter : document.getElementById('search').value).toLowerCase();
  let shown = memos.filter(m => m.title.toLowerCase().includes(q) || m.body.toLowerCase().includes(q));
  if (activeTagFilter) shown = shown.filter(m => (m.tags||[]).includes(activeTagFilter));

  // ãƒ”ãƒ³ç•™ã‚å„ªå…ˆã‚½ãƒ¼ãƒˆï¼ˆæ¤œç´¢ãƒ»ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œï¼‰
  shown.sort((a,b) => (b.pinned?1:0)-(a.pinned?1:0));
  shown.forEach((m, i) => {
    const el = document.createElement('div');
    el.className = 'memo-item' + (m.id===currentId?' active':'') + (m.pinned?' pinned':'');
    el.dataset.id = m.id;
    el.draggable = true;

    const tagsHtml = (m.tags||[]).length > 0
      ? '<div class="memo-item-tags">'+m.tags.map(t=>'<span class="tag-chip">#'+esc(t)+'</span>').join('')+'</div>'
      : '';

    el.innerHTML = `
      <div class="memo-item-title">
        <span class="memo-item-drag" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ">â ¿</span>
        ${m.pinned?'<span class="pin-icon">ğŸ“Œ</span>':''}
        ${esc(m.title||'ç„¡é¡Œ')}
      </div>
      <div class="memo-item-meta">${m.updatedAt?fmtDate(m.updatedAt):'â€”'}</div>
      <div class="memo-item-preview">${esc((m.body||'').replace(/\n/g,' ').slice(0,60))}</div>
      ${tagsHtml}
    `;

    el.addEventListener('click', () => { closeSidebar(); selectMemo(m.id); });

    // Drag & Drop
    el.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', m.id);
      setTimeout(() => el.classList.add('dragging'), 0);
    });
    el.addEventListener('dragend', () => el.classList.remove('dragging'));
    el.addEventListener('dragover', e => { e.preventDefault(); el.classList.add('drag-over'); });
    el.addEventListener('dragleave', () => el.classList.remove('drag-over'));
    el.addEventListener('drop', e => {
      e.preventDefault();
      el.classList.remove('drag-over');
      const fromId = e.dataTransfer.getData('text/plain');
      const toId = m.id;
      if (fromId === toId) return;
      const fromIdx = memos.findIndex(x=>x.id===fromId);
      const toIdx   = memos.findIndex(x=>x.id===toId);
      if (fromIdx===-1||toIdx===-1) return;
      const [moved] = memos.splice(fromIdx, 1);
      memos.splice(toIdx, 0, moved);
      renderList();
      markPending();
    });

    list.appendChild(el);
  });
}

document.getElementById('search').addEventListener('input', e => renderList(e.target.value));

// â”€â”€ Select memo â”€â”€
function selectMemo(id) {
  currentId = id;
  const m = memos.find(x=>x.id===id);
  if (!m) return;
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('editor').style.display = 'flex';
  document.getElementById('title-input').value = m.title||'';
  document.getElementById('memo-body').value   = m.body||'';
  updateCount(); updateMeta(m); renderTagEditor(m); updatePinBtn(m); renderList();
}

function updateMeta(m) {
  const el = document.getElementById('meta-info');
  if (!m) { el.textContent=''; return; }
  const parts=[];
  if(m.createdAt) parts.push('ä½œæˆ: '+fmtDate(m.createdAt));
  if(m.updatedAt) parts.push('æ›´æ–°: '+fmtDate(m.updatedAt));
  el.textContent = parts.join('ã€€');
}

// â”€â”€ Tag editor â”€â”€
function renderTagEditor(m) {
  const editor = document.getElementById('tag-editor');
  // remove old chips
  [...editor.querySelectorAll('.tag-edit-chip')].forEach(c=>c.remove());
  const inp = document.getElementById('tag-input');
  (m.tags||[]).forEach(t => {
    const chip = document.createElement('span');
    chip.className = 'tag-edit-chip';
    chip.innerHTML = '#'+esc(t)+' <button title="å‰Šé™¤">Ã—</button>';
    chip.querySelector('button').addEventListener('click', () => {
      m.tags = m.tags.filter(x=>x!==t);
      renderTagEditor(m); renderTagFilterBar(); renderList(); markPending();
    });
    editor.insertBefore(chip, inp);
  });
}

document.getElementById('tag-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    const val = e.target.value.trim().replace(/[,#\s]+/g,'');
    if (!val) return;
    const m = memos.find(x=>x.id===currentId);
    if (!m) return;
    if (!m.tags) m.tags=[];
    if (!m.tags.includes(val)) {
      m.tags.push(val);
      renderTagEditor(m); renderTagFilterBar(); renderList(); markPending();
    }
    e.target.value = '';
  }
  if (e.key === 'Backspace' && e.target.value === '') {
    const m = memos.find(x=>x.id===currentId);
    if (m && m.tags && m.tags.length > 0) {
      m.tags.pop();
      renderTagEditor(m); renderTagFilterBar(); renderList(); markPending();
    }
  }
});

// â”€â”€ Sync editor to state â”€â”€
document.getElementById('title-input').addEventListener('input', syncEditor);
document.getElementById('memo-body').addEventListener('input', () => { syncEditor(); updateCount(); markPending(); });

function syncEditor() {
  const m = memos.find(x=>x.id===currentId);
  if (!m) return;
  m.title = document.getElementById('title-input').value;
  m.body  = document.getElementById('memo-body').value;
  renderList();
}

function updateCount() {
  document.getElementById('char-count').textContent = document.getElementById('memo-body').value.length+' æ–‡å­—';
}

// â”€â”€ New â”€â”€
document.getElementById('btn-new').addEventListener('click', () => {
  const now = new Date().toISOString();
  const m = { id:genId(), title:'', body:'', tags:[], pinned:false, createdAt:now, updatedAt:now };
  memos.unshift(m);
  renderTagFilterBar(); renderList(); selectMemo(m.id);
  document.getElementById('title-input').focus();
  closeSidebar();
});

// â”€â”€ Save â”€â”€
document.getElementById('btn-save').addEventListener('click', save);
document.addEventListener('keydown', e => {
  if ((e.ctrlKey||e.metaKey) && e.key==='s') { e.preventDefault(); save(); }
});

async function save(silent=false) {
  if (!currentId) return;
  const m = memos.find(x=>x.id===currentId);
  if (!m) return;
  m.updatedAt = new Date().toISOString();
  const btn = document.getElementById('btn-save');
  btn.disabled = true;
  setStatus('ä¿å­˜ä¸­â€¦');
  if (autosaveEnabled) showAutosaveIndicator();
  try {
    await apiPatch(buildPatch());
    savedSnapshot = deepClone(memos);
    pendingChanges = false;
    setStatus('ä¿å­˜æ¸ˆã¿');
    if (!silent) toast('ä¿å­˜ã—ã¾ã—ãŸ âœ“');
    updateMeta(m); renderList();
    createBackup(true); // ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  } catch(e) {
    setStatus('ä¿å­˜å¤±æ•—');
    if (!silent) toast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
  } finally {
    btn.disabled = false;
  }
}

// â”€â”€ Autosave â”€â”€
document.getElementById('autosave-toggle').addEventListener('change', e => {
  autosaveEnabled = e.target.checked;
  localStorage.setItem('gm_autosave', autosaveEnabled);
  if (!autosaveEnabled) { clearInterval(autosaveTimer); autosaveTimer=null; }
  else scheduleAutosave();
  toast(autosaveEnabled ? 'è‡ªå‹•ä¿å­˜ ONï¼ˆ30ç§’ã”ã¨ï¼‰' : 'è‡ªå‹•ä¿å­˜ OFF');
});

function scheduleAutosave() {
  if (autosaveTimer) clearInterval(autosaveTimer);
  if (!autosaveEnabled) return;
  autosaveTimer = setInterval(() => {
    if (pendingChanges) save(true);
  }, 30000);
}

function markPending() {
  pendingChanges = true;
  if (autosaveEnabled && !autosaveTimer) scheduleAutosave();
}

function showAutosaveIndicator() {
  const el = document.getElementById('autosave-indicator');
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}

// â”€â”€ Revert â”€â”€
document.getElementById('btn-revert').addEventListener('click', () => {
  if (!confirm('æœ€å¾Œã«ä¿å­˜ã—ãŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')||!savedSnapshot) return;
  memos = deepClone(savedSnapshot);
  renderTagFilterBar(); renderList();
  const still = memos.find(x=>x.id===currentId);
  if (still) selectMemo(still.id);
  else { currentId=null; document.getElementById('editor').style.display='none'; document.getElementById('empty-state').style.display='flex'; }
});

// â”€â”€ Delete â”€â”€
document.getElementById('btn-delete').addEventListener('click', async () => {
  if (!currentId) return;
  const m = memos.find(x=>x.id===currentId);
  if (!confirm('ã€Œ'+(m?.title||'ç„¡é¡Œ')+'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  memos = memos.filter(x=>x.id!==currentId);
  currentId=null;
  document.getElementById('editor').style.display='none';
  document.getElementById('empty-state').style.display='flex';
  renderTagFilterBar(); renderList();
  setStatus('å‰Šé™¤ä¸­â€¦');
  try {
    await apiPatch(buildPatch());
    savedSnapshot=deepClone(memos);
    setStatus('ä¿å­˜æ¸ˆã¿'); toast('å‰Šé™¤ã—ã¾ã—ãŸ');
  } catch(e) { setStatus('å‰Šé™¤å¤±æ•—'); toast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ',true); }
});

// â”€â”€ Build Patch â”€â”€
function buildPatch() {
  const files={};
  files['index.json']={ content: JSON.stringify(memos.map(m=>m.id)) };
  memos.forEach(m => {
    files['memo_'+m.id+'.json']={ content: JSON.stringify({title:m.title,body:m.body,tags:m.tags||[],pinned:m.pinned||false,createdAt:m.createdAt,updatedAt:m.updatedAt}) };
  });
  // å‰Šé™¤ã•ã‚ŒãŸãƒ¡ãƒ¢ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¶ˆã™ï¼ˆsavedSnapshotã«å­˜åœ¨ã—ãŸã‚‚ã®ã®ã¿ï¼‰
  if (savedSnapshot) {
    const cur = new Set(memos.map(m=>m.id));
    savedSnapshot.forEach(m=>{ if(!cur.has(m.id)) files['memo_'+m.id+'.json']=null; });
  }
  // memo.txt ã¯åˆå›ã®ã¿å­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€knownFiles ã«å«ã¾ã‚Œã‚‹å ´åˆã®ã¿å‰Šé™¤
  if (knownFiles.has('memo.txt')) {
    files['memo.txt'] = null;
    knownFiles.delete('memo.txt');
  }
  return files;
}

// â”€â”€ API â”€â”€
async function apiGet() {
  const res = await fetch('https://api.github.com/gists/'+gistId,{
    headers:{ Authorization:'token '+token, Accept:'application/vnd.github.v3+json' }
  });
  if(!res.ok) throw new Error(res.status);
  return res.json();
}
async function apiPatch(files) {
  const res = await fetch('https://api.github.com/gists/'+gistId,{
    method:'PATCH',
    headers:{ Authorization:'token '+token, Accept:'application/vnd.github.v3+json', 'Content-Type':'application/json' },
    body: JSON.stringify({files})
  });
  if(!res.ok) throw new Error(res.status);
  return res.json();
}

// â”€â”€ Mobile â”€â”€
function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open'); }
function closeSidebar(){ document.getElementById('sidebar').classList.remove('open'); }

// â”€â”€ Utils â”€â”€
function genId(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
function deepClone(x){ return JSON.parse(JSON.stringify(x)); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function fmtDate(iso){
  if(!iso)return '';
  const d=new Date(iso),p=n=>String(n).padStart(2,'0');
  return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+' '+p(d.getHours())+':'+p(d.getMinutes());
}
function setStatus(msg){ document.getElementById('status-badge').textContent=msg; }
let toastTimer;
function toast(msg,isError=false){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='show'+(isError?' error':'');
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.className='',2800);
}

// â”€â”€ Pin â”€â”€
document.getElementById('btn-pin').addEventListener('click', () => {
  const m = memos.find(x=>x.id===currentId);
  if (!m) return;
  m.pinned = !m.pinned;
  updatePinBtn(m);
  renderList();
  markPending();
  toast(m.pinned ? 'ğŸ“Œ ãƒ”ãƒ³ç•™ã‚ã—ã¾ã—ãŸ' : 'ãƒ”ãƒ³ç•™ã‚ã‚’è§£é™¤ã—ã¾ã—ãŸ');
});

function updatePinBtn(m) {
  const btn = document.getElementById('btn-pin');
  if (!btn) return;
  btn.textContent = m?.pinned ? 'ğŸ“Œ è§£é™¤' : 'ğŸ“Œ ãƒ”ãƒ³ç•™ã‚';
  btn.style.color = m?.pinned ? 'var(--accent)' : '';
  btn.style.borderColor = m?.pinned ? 'var(--accent)' : '';
}

// â”€â”€ Export â”€â”€
document.getElementById('btn-export-open').addEventListener('click', () => {
  document.getElementById('export-modal').classList.add('open');
});
document.getElementById('export-cancel').addEventListener('click', () => {
  document.getElementById('export-modal').classList.remove('open');
});
document.getElementById('export-modal').addEventListener('click', e => {
  if (e.target === document.getElementById('export-modal'))
    document.getElementById('export-modal').classList.remove('open');
});

document.getElementById('exp-txt').addEventListener('click', () => {
  const m = memos.find(x=>x.id===currentId);
  if (!m) { toast('ãƒ¡ãƒ¢ã‚’é¸æŠã—ã¦ãã ã•ã„', true); return; }
  download(m.title||'memo', '.txt', m.body);
  document.getElementById('export-modal').classList.remove('open');
});

document.getElementById('exp-md').addEventListener('click', () => {
  const m = memos.find(x=>x.id===currentId);
  if (!m) { toast('ãƒ¡ãƒ¢ã‚’é¸æŠã—ã¦ãã ã•ã„', true); return; }
  const tags = (m.tags||[]).length > 0 ? '\ntags: ' + m.tags.map(t=>'#'+t).join(' ') : '';
  const updated = m.updatedAt ? '\nupdated: ' + fmtDate(m.updatedAt) : '';
  const content = '# ' + (m.title||'ç„¡é¡Œ') + tags + updated + '\n\n' + m.body;
  download(m.title||'memo', '.md', content);
  document.getElementById('export-modal').classList.remove('open');
});

document.getElementById('exp-all').addEventListener('click', () => {
  const lines = memos.map(m => {
    const tags = (m.tags||[]).length > 0 ? '\ntags: ' + m.tags.map(t=>'#'+t).join(' ') : '';
    const updated = m.updatedAt ? '\nupdated: ' + fmtDate(m.updatedAt) : '';
    return '# ' + (m.title||'ç„¡é¡Œ') + tags + updated + '\n\n' + m.body;
  });
  download('gist-memo-all', '.md', lines.join('\n\n---\n\n'));
  document.getElementById('export-modal').classList.remove('open');
});

function download(name, ext, text) {
  const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = name.replace(/[/\\:*?"<>|]/g,'_') + ext;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
  toast('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ âœ“');
}

// â”€â”€ Backup â”€â”€
const BACKUP_MAX = 10;

document.getElementById('btn-backup-open').addEventListener('click', () => {
  renderBackupList();
  document.getElementById('backup-modal').classList.add('open');
});
document.getElementById('backup-cancel').addEventListener('click', () => {
  document.getElementById('backup-modal').classList.remove('open');
});
document.getElementById('backup-modal').addEventListener('click', e => {
  if (e.target === document.getElementById('backup-modal'))
    document.getElementById('backup-modal').classList.remove('open');
});
document.getElementById('btn-backup-now').addEventListener('click', async () => {
  await createBackup();
  renderBackupList();
});

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚­ãƒ¼ä¸€è¦§ã¯ãƒ¡ãƒ¢ãƒªã§ç®¡ç†ï¼ˆä½™åˆ†ãªAPIå‘¼ã³å‡ºã—ã‚’é¿ã‘ã‚‹ï¼‰
let backupKeys = []; // ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆæœŸåŒ–
let knownFiles = new Set(); // Gistä¸Šã«å®Ÿåœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¿½è·¡

async function createBackup(silent=false) {
  if (memos.length === 0) return;
  const now = new Date();
  const key = 'bk_' + now.toISOString().replace(/[:.]/g,'').slice(0,15);
  const snapshot = { createdAt: now.toISOString(), memos: deepClone(memos) };
  const files = {};

  // æ–°ã—ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è¿½åŠ 
  files[key + '.json'] = { content: JSON.stringify(snapshot) };

  // ãƒ¡ãƒ¢ãƒªä¸Šã®ã‚­ãƒ¼ä¸€è¦§ã‚’æ›´æ–°ã—ã€è¶…éåˆ†ã‚’å‰Šé™¤
  backupKeys = [...backupKeys, key].sort();
  if (backupKeys.length > BACKUP_MAX) {
    const toDelete = backupKeys.splice(0, backupKeys.length - BACKUP_MAX);
    toDelete.forEach(k => { files[k + '.json'] = null; });
  }

  try {
    await apiPatch(files);
    if (!silent) toast('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ âœ“');
  } catch(e) {
    // å¤±æ•—ã—ãŸå ´åˆã¯ã‚­ãƒ¼ä¸€è¦§ã‚’å…ƒã«æˆ»ã™
    backupKeys = backupKeys.filter(k => k !== key);
    if (!silent) toast('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', true);
  }
}

async function renderBackupList() {
  const listEl = document.getElementById('backup-list');
  listEl.innerHTML = '<div class="backup-empty">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
  try {
    const data = await apiGet();
    const keys = Object.keys(data.files)
      .filter(f => f.startsWith('bk_') && f.endsWith('.json'))
      .sort().reverse(); // æ–°ã—ã„é †

    if (keys.length === 0) {
      listEl.innerHTML = '<div class="backup-empty">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    listEl.innerHTML = '';
    keys.forEach(fname => {
      let snapshot = null;
      try { snapshot = JSON.parse(data.files[fname].content); } catch(e) {}
      if (!snapshot) return;

      const memoCount = (snapshot.memos || []).length;
      const dateStr = snapshot.createdAt ? fmtDate(snapshot.createdAt) : fname;

      const item = document.createElement('div');
      item.className = 'backup-item';
      item.innerHTML = `
        <div class="backup-item-info">
          <div class="backup-item-date">${dateStr}</div>
          <div class="backup-item-meta">${memoCount} ä»¶ã®ãƒ¡ãƒ¢</div>
        </div>
        <button class="backup-item-btn">ã“ã®æ™‚ç‚¹ã«æˆ»ã™</button>
      `;
      item.querySelector('button').addEventListener('click', () => {
        restoreBackup(snapshot, dateStr);
      });
      listEl.appendChild(item);
    });
  } catch(e) {
    listEl.innerHTML = '<div class="backup-empty">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}

function restoreBackup(snapshot, dateStr) {
  if (!confirm(dateStr + ' ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®å†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) return;
  memos = deepClone(snapshot.memos || []);
  savedSnapshot = deepClone(memos);
  currentId = null;
  document.getElementById('editor').style.display = 'none';
  document.getElementById('empty-state').style.display = 'flex';
  renderTagFilterBar();
  renderList();
  document.getElementById('backup-modal').classList.remove('open');
  toast('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ âœ“');
  // Gistã«ã‚‚åæ˜ 
  apiPatch(buildPatch()).catch(() => toast('Gistã¸ã®åæ˜ ã«å¤±æ•—ã—ã¾ã—ãŸ', true));
}
</script>
</body>
</html>
